"""
3D_script.py
PyOpenGL script
runs with python 2.7
first command line parameter: sunlight data text file name
"""

import numpy as np
import pygame
import sys
from pygame.locals import *
from OpenGL.GL import *
from OpenGL.GLU import *
from sunlit_surface_module import *

def read_sunlight_data(file_name):
    """
    read sunlight data
    input:
     - file_name    string
    output:
     - sunlight     numpy array of floats (shape len(time), len(lat), len(lon))
     - time         list of strings
     - lat          list of strings
     - lon          list of strings
    """

    with open(file_name, "r") as file:

        file_contents = file.readlines()

    time = file_contents[12][:-1].split(",")

    for i in range(len(time)):

        time[i] = float(time[i])

    lat = file_contents[15][:-1].split(",")

    for i in range(len(lat)):

        lat[i] = float(lat[i])

    lon = file_contents[18][:-1].split(",")

    for i in range(len(lon)):

        lon[i] = float(lon[i])

    sunlight = np.zeros((len(time), len(lat), len(lon)))

    for i in range(len(time)):
        for j in range(len(lat)):
            for k in range(len(lon)):

                sunlight[i, j, k] = file_contents[21 + i * len(lat) + j].split(",")[k]

    return sunlight, time, lat, lon

def colorbar(float, data_array, color_array):
    """
    returns RGB triplet when given float between 0 and 1
    input:
     - float        float between 0 and 1
     - data_array   list
     - color_array  list of RGB triplets (lists of 3 floats)
    output:
     - RGB          list of 3 floats
    """

    max = np.amax(data_array)

    min = np.amin(data_array)

    if max == min:

        float = 0.0

    else:

        float = (float - min) / (max - min)

    index = int(round(float * (len(color_array) - 1)))

    RGB = color_array[index]

    return RGB

sunlight, time, lat, lon = read_sunlight_data(sys.argv[1])

# Declaring planetary constants
PLANET_RADIUS = 2440 # in km

vertices = []
for i in range(len(lat)):
    for j in range(len(lon)):
        vertices.append(geographic_to_cartesian_coord(lat[i], lon[j], PLANET_RADIUS))

edges = []
for i in range(len(lat) - 1):
    for j in range(len(lon) - 1):
        edges.append((j + i*len(lon), j+1 + i*len(lon)))
        edges.append((j+1 + i*len(lon), j+1 + (i+1)*len(lon)))
        edges.append((j+1 + (i+1)*len(lon), j + (i+1)*len(lon)))
        edges.append((j+ (i+1)*len(lon), j + i*len(lon)))

surfaces = []
for i in range(len(lat) - 1):
    for j in range(len(lon) - 1):
        surfaces.append((
            j + i*len(lon),
            j+1 + i*len(lon),
            j+1 + (i+1)*len(lon),
            j + (i+1)*len(lon)
        ))

colors = [
    [0.,0.,0.],
    [0.01568627450980392,0.,0.011764705882352941],
    [0.03529411764705882,0.,0.027450980392156862],
    [0.050980392156862744,0.,0.0392156862745098],
    [0.07058823529411765,0.,0.054901960784313725],
    [0.08627450980392157,0.,0.07450980392156863],
    [0.10588235294117647,0.,0.09019607843137255],
    [0.12156862745098039,0.,0.10980392156862745],
    [0.1411764705882353,0.,0.12549019607843137],
    [0.1568627450980392,0.,0.14901960784313725],
    [0.1764705882352941,0.,0.16862745098039217],
    [0.19607843137254902,0.,0.18823529411764706],
    [0.21176470588235294,0.,0.20784313725490194],
    [0.22745098039215686,0.,0.23137254901960785],
    [0.2392156862745098,0.,0.24705882352941178],
    [0.25098039215686274,0.,0.26666666666666666],
    [0.26666666666666666,0.,0.2823529411764706],
    [0.27058823529411763,0.,0.30196078431372547],
    [0.2823529411764706,0.,0.3176470588235294],
    [0.2901960784313725,0.,0.33725490196078434],
    [0.30196078431372547,0.,0.3568627450980392],
    [0.30980392156862746,0.,0.37254901960784315],
    [0.3137254901960784,0.,0.39215686274509803],
    [0.32156862745098036,0.,0.40784313725490196],
    [0.3254901960784314,0.,0.42745098039215684],
    [0.3333333333333333,0.,0.44313725490196076],
    [0.32941176470588235,0.,0.4627450980392157],
    [0.33725490196078434,0.,0.4784313725490196],
    [0.3411764705882353,0.,0.4980392156862745],
    [0.34509803921568627,0.,0.5176470588235293],
    [0.33725490196078434,0.,0.5333333333333333],
    [0.3411764705882353,0.,0.5529411764705883],
    [0.3411764705882353,0.,0.5686274509803921],
    [0.3411764705882353,0.,0.5882352941176471],
    [0.3333333333333333,0.,0.6039215686274509],
    [0.32941176470588235,0.,0.6235294117647059],
    [0.32941176470588235,0.,0.6392156862745098],
    [0.32941176470588235,0.,0.6588235294117647],
    [0.3254901960784314,0.,0.6784313725490196],
    [0.30980392156862746,0.,0.6941176470588235],
    [0.3058823529411765,0.,0.7137254901960784],
    [0.30196078431372547,0.,0.7294117647058823],
    [0.2980392156862745,0.,0.7490196078431373],
    [0.2784313725490196,0.,0.7647058823529411],
    [0.27450980392156865,0.,0.7843137254901961],
    [0.26666666666666666,0.,0.8],
    [0.2588235294117647,0.,0.8196078431372549],
    [0.23529411764705882,0.,0.8392156862745098],
    [0.22745098039215686,0.,0.8549019607843137],
    [0.21568627450980393,0.,0.8745098039215686],
    [0.20784313725490194,0.,0.8901960784313725],
    [0.1803921568627451,0.,0.9098039215686274],
    [0.16862745098039217,0.,0.9254901960784314],
    [0.1568627450980392,0.,0.9450980392156862],
    [0.1411764705882353,0.,0.9607843137254902],
    [0.12941176470588234,0.,0.9803921568627451],
    [0.09803921568627451,0.,1.],
    [0.08235294117647059,0.,1.],
    [0.06274509803921569,0.,1.],
    [0.047058823529411764,0.,1.],
    [0.01568627450980392,0.,1.],
    [0.,0.,1.],
    [0.,0.01568627450980392,1.],
    [0.,0.03137254901960784,1.],
    [0.,0.06274509803921569,1.],
    [0.,0.08235294117647059,1.],
    [0.,0.09803921568627451,1.],
    [0.,0.11372549019607843,1.],
    [0.,0.14901960784313725,1.],
    [0.,0.16470588235294117,1.],
    [0.,0.1803921568627451,1.],
    [0.,0.2,1.],
    [0.,0.21568627450980393,1.],
    [0.,0.24705882352941178,1.],
    [0.,0.2627450980392157,1.],
    [0.,0.2823529411764706,1.],
    [0.,0.2980392156862745,1.],
    [0.,0.32941176470588235,1.],
    [0.,0.34901960784313724,1.],
    [0.,0.36470588235294116,1.],
    [0.,0.3803921568627451,1.],
    [0.,0.4156862745098039,1.],
    [0.,0.43137254901960786,1.],
    [0.,0.44705882352941173,1.],
    [0.,0.4666666666666667,1.],
    [0.,0.4980392156862745,1.],
    [0.,0.5137254901960784,1.],
    [0.,0.5294117647058824,1.],
    [0.,0.5490196078431373,1.],
    [0.,0.5647058823529412,1.],
    [0.,0.596078431372549,1.],
    [0.,0.615686274509804,1.],
    [0.,0.6313725490196078,1.],
    [0.,0.6470588235294118,1.],
    [0.,0.6823529411764706,1.],
    [0.,0.6980392156862745,1.],
    [0.,0.7137254901960784,1.],
    [0.,0.7333333333333333,1.],
    [0.,0.7647058823529411,1.],
    [0.,0.7803921568627451,1.],
    [0.,0.796078431372549,1.],
    [0.,0.8156862745098039,1.],
    [0.,0.8470588235294118,1.],
    [0.,0.8627450980392157,1.],
    [0.,0.8823529411764706,1.],
    [0.,0.8980392156862745,1.],
    [0.,0.9137254901960784,1.],
    [0.,0.9490196078431372,1.],
    [0.,0.9647058823529412,1.],
    [0.,0.9803921568627451,1.],
    [0.,1.,1.],
    [0.,1.,0.9647058823529412],
    [0.,1.,0.9490196078431372],
    [0.,1.,0.9333333333333333],
    [0.,1.,0.9137254901960784],
    [0.,1.,0.8823529411764706],
    [0.,1.,0.8627450980392157],
    [0.,1.,0.8470588235294118],
    [0.,1.,0.8313725490196078],
    [0.,1.,0.796078431372549],
    [0.,1.,0.7803921568627451],
    [0.,1.,0.7647058823529411],
    [0.,1.,0.7490196078431373],
    [0.,1.,0.7333333333333333],
    [0.,1.,0.6980392156862745],
    [0.,1.,0.6823529411764706],
    [0.,1.,0.6666666666666666],
    [0.,1.,0.6470588235294118],
    [0.,1.,0.615686274509804],
    [0.,1.,0.596078431372549],
    [0.,1.,0.580392156862745],
    [0.,1.,0.5647058823529412],
    [0.,1.,0.5294117647058824],
    [0.,1.,0.5137254901960784],
    [0.,1.,0.4980392156862745],
    [0.,1.,0.4823529411764706],
    [0.,1.,0.44705882352941173],
    [0.,1.,0.43137254901960786],
    [0.,1.,0.4156862745098039],
    [0.,1.,0.4],
    [0.,1.,0.3803921568627451],
    [0.,1.,0.34901960784313724],
    [0.,1.,0.32941176470588235],
    [0.,1.,0.3137254901960784],
    [0.,1.,0.2980392156862745],
    [0.,1.,0.2627450980392157],
    [0.,1.,0.24705882352941178],
    [0.,1.,0.23137254901960785],
    [0.,1.,0.21568627450980393],
    [0.,1.,0.1803921568627451],
    [0.,1.,0.16470588235294117],
    [0.,1.,0.14901960784313725],
    [0.,1.,0.13333333333333333],
    [0.,1.,0.09803921568627451],
    [0.,1.,0.08235294117647059],
    [0.,1.,0.06274509803921569],
    [0.,1.,0.047058823529411764],
    [0.,1.,0.03137254901960784],
    [0.,1.,0.],
    [0.01568627450980392,1.,0.],
    [0.03137254901960784,1.,0.],
    [0.047058823529411764,1.,0.],
    [0.08235294117647059,1.,0.],
    [0.09803921568627451,1.,0.],
    [0.11372549019607843,1.,0.],
    [0.12941176470588234,1.,0.],
    [0.16470588235294117,1.,0.],
    [0.1803921568627451,1.,0.],
    [0.2,1.,0.],
    [0.21568627450980393,1.,0.],
    [0.24705882352941178,1.,0.],
    [0.2627450980392157,1.,0.],
    [0.2823529411764706,1.,0.],
    [0.2980392156862745,1.,0.],
    [0.3137254901960784,1.,0.],
    [0.34901960784313724,1.,0.],
    [0.36470588235294116,1.,0.],
    [0.3803921568627451,1.,0.],
    [0.396078431372549,1.,0.],
    [0.43137254901960786,1.,0.],
    [0.44705882352941173,1.,0.],
    [0.4666666666666667,1.,0.],
    [0.4823529411764706,1.,0.],
    [0.5137254901960784,1.,0.],
    [0.5294117647058824,1.,0.],
    [0.5490196078431373,1.,0.],
    [0.5647058823529412,1.,0.],
    [0.6,1.,0.],
    [0.615686274509804,1.,0.],
    [0.6313725490196078,1.,0.],
    [0.6470588235294118,1.,0.],
    [0.6627450980392157,1.,0.],
    [0.6980392156862745,1.,0.],
    [0.7137254901960784,1.,0.],
    [0.7333333333333333,1.,0.],
    [0.7490196078431373,1.,0.],
    [0.7803921568627451,1.,0.],
    [0.796078431372549,1.,0.],
    [0.8156862745098039,1.,0.],
    [0.8313725490196078,1.,0.],
    [0.8666666666666667,1.,0.],
    [0.8823529411764706,1.,0.],
    [0.8980392156862745,1.,0.],
    [0.9137254901960784,1.,0.],
    [0.9490196078431372,1.,0.],
    [0.9647058823529412,1.,0.],
    [0.9803921568627451,1.,0.],
    [1.,1.,0.],
    [1.,0.9803921568627451,0.],
    [1.,0.9490196078431372,0.],
    [1.,0.9333333333333333,0.],
    [1.,0.9137254901960784,0.],
    [1.,0.8980392156862745,0.],
    [1.,0.8666666666666667,0.],
    [1.,0.8470588235294118,0.],
    [1.,0.8313725490196078,0.],
    [1.,0.8156862745098039,0.],
    [1.,0.7803921568627451,0.],
    [1.,0.7647058823529411,0.],
    [1.,0.7490196078431373,0.],
    [1.,0.7333333333333333,0.],
    [1.,0.6980392156862745,0.],
    [1.,0.6823529411764706,0.],
    [1.,0.6666666666666666,0.],
    [1.,0.6470588235294118,0.],
    [1.,0.6313725490196078,0.],
    [1.,0.6,0.],
    [1.,0.580392156862745,0.],
    [1.,0.5647058823529412,0.],
    [1.,0.5490196078431373,0.],
    [1.,0.5137254901960784,0.],
    [1.,0.4980392156862745,0.],
    [1.,0.4823529411764706,0.],
    [1.,0.4666666666666667,0.],
    [1.,0.43137254901960786,0.],
    [1.,0.4156862745098039,0.],
    [1.,0.4,0.],
    [1.,0.3803921568627451,0.],
    [1.,0.34901960784313724,0.],
    [1.,0.3333333333333333,0.],
    [1.,0.3137254901960784,0.],
    [1.,0.2980392156862745,0.],
    [1.,0.2823529411764706,0.],
    [1.,0.24705882352941178,0.],
    [1.,0.23137254901960785,0.],
    [1.,0.21568627450980393,0.],
    [1.,0.2,0.],
    [1.,0.16470588235294117,0.],
    [1.,0.14901960784313725,0.],
    [1.,0.13333333333333333,0.],
    [1.,0.11372549019607843,0.],
    [1.,0.08235294117647059,0.],
    [1.,0.06666666666666667,0.],
    [1.,0.047058823529411764,0.],
    [1.,0.03137254901960784,0.]
]

def globe(sunlight_data, i):

    glBegin(GL_QUADS)

    for i in range(len(surfaces)):

        glColor3fv(colorbar(sunlight_data[i], sunlight_data, colors))

        for vertex in surfaces[i]:

            glVertex3fv(vertices[vertex])

    glEnd()

    glBegin(GL_LINES)

    glColor4fv((1, 1, 1, 0.5))

    for edge in edges:

        for vertex in edge:

            glVertex3fv(vertices[vertex])

    glEnd()

def main(sunlight):

    i = 0 # initializing time counter

    pygame.init()

    display = (800, 600)

    pygame.display.set_mode(display, DOUBLEBUF|OPENGL)

    gluPerspective(45, (display[0]/display[1]), 0.1, 500000.0)

    glTranslatef(0.0, 0.0, -10000.0)

    glRotatef(0, 1, 0, 0)

    glRotatef(90, 0, 0, 1)

    while True:

        # resetting time counter to zero when reached the end of the animation
        if i == len(sunlight):

            i = 0

        # storing data from numpy array to a list that has the same shape as "surfaces"
        sunlight_data = []

        for j in range(len(sunlight[i]) - 1):

            for k in range(len(sunlight[i][j]) - 1):

                sunlight_data.append(sunlight[i, j, k])

        for event in pygame.event.get():

            if event.type == pygame.QUIT:

                pygame.quit()

                quit()

        #glRotatef(1, 1, 1, 1)

        glClear(GL_COLOR_BUFFER_BIT|GL_DEPTH_BUFFER_BIT)

        globe(sunlight_data, i)

        pygame.display.flip()

        pygame.time.wait(20)

        i += 1 # increasing time counter

main(sunlight)
